# fraud_data_research - разведочный анализ, предобработка и модель для обнаружения мошенничества


## 1. Данные

* Источник: анонимизированные финансовые транзакции (включая `amount`, `timestamp`, `vendor_*`, `device`, `channel`, `country`, `card_type`, `last_hour_activity`, булевы флаги и метку `is_fraud`).
* Вспомогательные данные: исторические курсы валют (использованы для приведения сумм к USD).
* Использованные признаки в модели (после предобработки):

  * числовые: `hour`, `weekday`, `lh_num_transactions`, `lh_total_amount`, `lh_unique_merchants`, `lh_unique_countries`, `lh_max_single_amount`, `amount_usd`, `is_card_present`, `is_outside_home_country`, `is_high_risk_vendor`, `is_weekend`;
  * категориальные (кодированы OrdinalEncoder): `country`, `city_size`, `card_type`, `device`, `channel`.

## 2. Что сделано

1. **Разведочный анализ**: проверка дубликатов, пропусков, распределений, приведение сумм к USD с помощью `historical_currency_exchange`.
2. **Анализ аномалий**: обнаружены аномальные группы записей (см. раздел 4). Эти записи были исключены из обучения модели и отправлены на дополнительную проверку.
3. **Feature engineering**: извлечение временных признаков (`hour`, `weekday`), логарифм суммы, развернут `last_hour_activity` в отдельные числовые признаки. 
4. **Предобработка**: `SimpleImputer(median)` + `StandardScaler` для числовых; `SimpleImputer(constant)` + `OrdinalEncoder` для категориальных.
5. **Разделение данных**: train/test split (80 на 20). При тренировке использовалась подвыборка для ускорённого тюнинга
6. **Модель**: `LGBMClassifier`: Гиперпараметры подобраны RandomizedSearchCV (умеренное число итераций)
7. **Оценка**: вычислены метрики AP (average precision), ROC AUC, precision/recall/f1. Выполнена оценка важности признаков методом permutation importance.

## 4. Ключевые наблюдения / аномалии

* **Аномалия 1**: практически все транзакции с `amount_usd < $6` помечены как мошеннические.
* **Аномалия 2**: если `channel == "pos"` или `device` ∈ {`Chip Reader`, `NFC Payment`, `Magnetic Stripe`}, то такие транзакции также помечены как мошеннические в 100% случаев.

  * Вывод: вероятна проблема качества данных (ошибка ETL / тестовые записи / смещённая метка). Эти записи **исключены** из тренировочного набора.
* **География**: значительно больше мошеннических операций приходится на Мексику, Россию, Нигерию, Бразилию.
* **Время**: пик количества мошеннических транзакций наблюдается в интервале **01:00–05:00** (по имеющимся timestamp).
* **Поведенческие за последний час**: внесло небольшой вклад в модель по сравнению с суммой и страной.

## 5. Результаты модели

* Модель: LightGBM
* **Test AP (Average Precision)**: **0.9125**
* **Test ROC AUC**: **0.9831**
* Классификационный отчёт (test):

  * precision (class 0) = 0.9770, recall = 0.9915
  * precision (class 1) = 0.8978, recall = 0.7628
  * overall accuracy = 0.9710
  * f1 (fraud) = 0.8248
* **Permutation feature importance** (top):

  * `amount_usd`: **0.142642 ± 0.000203**
  * `country`: **0.068129 ± 0.000146**
  * `card_type`: **0.055957 ± 0.000112**
  * `is_outside_home_country`: **0.021496 ± 0.000092**
  * `is_high_risk_vendor`: **0.019315 ± 0.000115**
  * `hour`: **0.008882 ± 0.000073**
  * velocity-признаки: малый вклад (≈0.001 и меньше).
  * `is_card_present`, `is_weekend`, `weekday`: близки к нулю или отрицательны (нет положительного влияния).

## 6. Выводы и интерпретация результатов

1. Малые суммы в данных ассоциированы с мошенничеством, но это может быть особенностью данных. Кроме того в распределении мошеннических операций характерны более высокие суммы, что вероятно и служит предиктором
2. География  — значимый фактор: концентрированные рисковые рынки требуют отдельного внимания.
3. Тип карты и статус «вне домашней страны» дают существенный сигнал.
5. **Аномалии в данных** критичны: если их не убирать/исправить, модель будет переобучаться на ошибочных паттернах.

## 7. Практическое применение результатов

* Использовать модель для выдачи вероятности мошенничества (0–1) и принимать решения:

  * `score > high_threshold`, то отклонять автоматически (при строгой политике);
  * `score in [medium, high)`, то использовать доп факторы защиты (пуши, смс)
  * `score < medium`, то разрешить;

* Мониторить fraud rate по продавцам и принимать решения по лимитам/приёму.
* Усиленная верификация / лимитирование по странам с высокой долей мошенничества — с A/B тестированием влияния на конверсию.
Более строгая проверка для карт "вне дома", повышенный контроль ночных транзакций (01:00–05:00).
* Разобраться с маленькими суммами: либо отдельная модель, либо специфические правила, либо ручная проверка (пока не подтвердится валидность этих записей).
